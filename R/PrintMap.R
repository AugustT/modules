#' @title Output module: PrintMap
#'
#' @description Plot a map of predicted surface.
#'
#' @param .model \strong{Internal parameter, do not use in the workflow function}. \code{.model} is list of a data frame (\code{data}) and a model object (\code{model}). \code{.model} is passed automatically in workflow, combining data from the model module(s) and process module(s), to the output module(s) and should not be passed by the user.
#'
#' @param .ras \strong{Internal parameter, do not use in the workflow function}. \code{.ras} is a raster layer, brick or stack object. \code{.ras} is passed automatically in workflow from the covariate module(s) to the output module(s) and should not be passed by the user. 
#'
#' @param plot If \code{TRUE} the plot will be displayed in the device
#'
#' @param dir Directory where plots are saved. If \code{NULL} (default) then plots are
#' not saved. 
#' 
#' @param size A vector containing the width and height of the output figure when writing to a png file. Example: c(800,600).
#' 
#' @param res The output resolution in ppi when writing to a png file.
#'
#' @return A Raster object giving the probabilistic model predictions for each
#' cell of covariate raster layer
#'
#' @author ZOON Developers, \email{zoonproject@@gmail.com}; James Campbell, \email{jamesadamcampbell@@gmail.com}
#' @section Version: 1.1
#' @section Date submitted: 2016-04-02
#'
#' @name PrintMap
#' @family output
PrintMap <-
  function (.model, .ras, plot = TRUE, dir = NULL, size = c(480,480), res = 72) {
    
    zoon::GetPackage(raster)
    
    vals <- data.frame(getValues(.ras))
    colnames(vals) <- names(.ras)
    
    pred <- ZoonPredict(.model$model,
                        newdata = vals)
    
    pred_ras <- .ras[[1]]
    
    pred_ras <- setValues(pred_ras, pred)
    
    ## Define color pallete
    cls <- colorRampPalette(c('#e0f3db', '#a8ddb5', '#4eb3d3', '#08589e'))(10)
    
    par(mar = c(4, 4, 0, 2) + 0.1)
    ST <- format(Sys.time(), "%Y_%m_%d-%H%M")
    
    if(plot){
      if(any(.model$data$value == 0)){
        ## Define absence points
        points.absence <- SpatialPoints(coords = .model$data[.model$data$value == 0,c('longitude','latitude')])
        pl.absence <- list('sp.points', points.absence, pch=16, cex=1, col='#00000055')
      } 
      if(any(.model$data$value == 1)){
        ## Define presence points
        points.presence <- SpatialPoints(coords = .model$data[.model$data$value == 1,c('longitude','latitude')])
        pl.presence <- list('sp.points', points.presence, pch=16, cex=1, col='#e41a1c55')      
      }
      
      ## Create plot
      plot.object <- spplot(pred_ras,
                            sp.layout=list(pl.presence,pl.absence),
                            col.regions=cls,cuts=length(cls)-1,
                            scales = list(draw = TRUE),
                            key = list(corner = c(0,0),space = 'inside',text = list(c('Presence', 'Absence')), points = list(pch = 21,fill = c('#000000','#e41a1c'))))
      ## corner: between 0 and 1 for x and y, defines which corner to place the legend in. 
      print(plot.object)
    }
    
    ## Save to .png
    if(!is.null(dir)){
      # Create the filename
      preferred_name <- paste(ST, ".png", sep = '')
      
      if(!file.exists(ifelse(test = !is.null(dir),
                             yes = file.path(dir, preferred_name),
                             no = preferred_name))){
        
        plotname <- preferred_name
        
      } else {
        
        ex_files <- list.files(path = dir, pattern = paste('^', ST, sep = ''))
        
        if(length(ex_files) == 1){
          
          plotname <- paste(ST, '_2.png', sep = '')
          
        } else {
          
          ex_files <- gsub(paste('^', ST, sep = ''), '', gsub('.png$', '', ex_files))
          ex_files <- gsub('^_', '', ex_files)
          new_index <- max(as.numeric(ex_files), na.rm = TRUE) + 1
          plotname <- gsub('.png$', paste('_', new_index, '.png', sep = ''), preferred_name)
          
        }
      }
      ## Initiate png graphics device
      png(filename = ifelse(test = !is.null(dir),
                            yes = file.path(dir, plotname),
                            no = plotname),
          res = res,
          width = size[1],
          height = size[2])
      ## Push plot object to graphics device
      print(plot.object)
      ## Close graphics device (write image to file)
      dev.off()
    }
    
    return(pred_ras)
    
  }
